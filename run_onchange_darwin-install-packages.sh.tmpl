{{- $arch := .chezmoi.arch -}}
{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash

brew bundle --file=/dev/stdin <<EOF
{{- range .taps }}
tap {{ .name | quote }}
{{- end }}

{{- range $group, $packages := .brews }}
{{- printf "******** Group: %s" $group }}
  {{- range $pkg := $packages }}
brew install {{ $pkg }}
  {{- end }}
{{- end }}

{{- range $group, $packages := .casks }}
{{- printf "******** Group: %s" $group }}
  {{- range $pkg := $packages }}
brew install {{ $pkg }}
  {{- end }}
{{- end }}

{{- range .vscode_extensions }}
vscode {{ . | quote }}
{{- end }}
EOF

# Install Krew plugins
echo "Installing Krew plugins for architecture: {{ .chezmoi.arch }}"

{{- range .krew_plugins }}
  {{- if has $arch .architectures }}
if ! kubectl krew list | grep -q {{ .name }}; then
  echo "Installing krew plugin: {{ .name }}"
  kubectl krew install {{ .name }} || echo "Failed to install krew plugin: {{ .name }}"
else
  echo "Krew plugin {{ .name }} is already installed."
fi
  {{- end }}
{{- end }}

{{- end -}}